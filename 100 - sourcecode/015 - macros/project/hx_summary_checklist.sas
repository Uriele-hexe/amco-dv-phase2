*==================================================================================================                                                                                                                                                             
* Cliente : AMCO SpA                                                                                                                                                                                                                                            
* Office  : CRO Portfolio Managment -> Data Verification                                                                                                                                                                                                        
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Macro name  : hx_summary_checklist                                                                                                                                                                                                                            
* Description : Produce summary checks.                                                                                                                                                                                                                         
* Author      : Uriele De Piano Hexe SpA, 18 January 2021                                                                                                                                                                                                       
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Parameter:                                                                                                                                                                                                                                                    
*    	1) dsDetail -> Dataset of details name created by hx_run_check_list containing resultes of all                                                                                                                                                            
*										 idRule                                                                                                                                                                                                                                              
*                                                                                                                                                                                                                                                               
* In addition this, also macro variables declared and used in hx_run_check_list                                                                                                                                                                                 
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Output                                                                                                                                                                                                                                                        
*  - Temporary summary checks                                                                                                                                                                                                                                   
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* NOTE: Macro can be called only after hx_details_checklist execution                                                                                                                                                                                           
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Change versions                                                                                                                                                                                                                                               
*		versions	  : 1.0                                                                                                                                                                                                                                             
*		description : Create empty hash table with all idRule and Portfolio                                                                                                                                                                                          
*	  Author		: Uriele De Piano Hexe S.p.A                                                                                                                                                                                                                        
*		date        : 20 January 2021                                                                                                                                                                                                                                
* --------------------------------------------------------------------------------------------------                                                                                                                                                            
*		versions	  : 1.1                                                                                                                                                                                                                                             
*		description : Fill rules applied                                                                                                                                                                                                                             
*	  Author		: Uriele De Piano Hexe S.p.A                                                                                                                                                                                                                        
*		date        : 20 January 2021                                                                                                                                                                                                                                
* --------------------------------------------------------------------------------------------------                                                                                                                                                            
*		versions	  : 2.1                                                                                                                                                                                                                                             
*		description : Update total records. The total number of records will be referered to single portfolio                                                                                                                                                        
*	  Author		: Uriele De Piano Hexe S.p.A                                                                                                                                                                                                                        
*		date        : 21 January 2021                                                                                                                                                                                                                                
* --------------------------------------------------------------------------------------------------                                                                                                                                                            
*		versions	  : 2.2                                                                                                                                                                                                                                             
*		description : Update _LIST_PORTAFOGLI about excel files                                                                                                                                                                                                      
*	    Author		: Uriele De Piano Hexe S.p.A                                                                                                                                                                                                                      
*		date        : 21 January 2021                                                                                                                                                                                                                                
* --------------------------------------------------------------------------------------------------                                                                                                                                                            
*		versions	 : 2.3                                                                                                                                                                                                                                              
*		description : Check on ALL_RECONNECTION_TABLE based on filter to dta_reference                                                                                                                                                                               
*	    Author		: Uriele De Piano Hexe S.p.A                                                                                                                                                                                                                      
*		date        : 21 January 2021                                                                                                                                                                                                                                
* --------------------------------------------------------------------------------------------------                                                                                                                                                            
*		versions	 : 2.4                                                                                                                                                                                                                                              
*		description : Add cod_portafoglio_gest if this exits in data                                                                                                                                                                                                 
*	    Author		: Uriele De Piano Hexe S.p.A                                                                                                                                                                                                                      
*		date        : 26 February 2021                                                                                                                                                                                                                               
*==================================================================================================                                                                                                                                                             
;                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
%Macro hx_summary_checklist(dsDetails=_null_,dsHistCheck=_null_ ) / store secure ;                                                                                                                                                                              
	%Local _tmpStamp _raccordoTotale _hasPortfolio _hasPortfolio_ND                                                                                                                                                                                                
			;                                                                                                                                                                                                                                                            
	%Let _tmpStamp = %sysfunc(putn(%sysfunc(datetime()),datetime.));                                                                                                                                                                                               
	%Put +---[Macro: &sysmacroname.] -------------+;                                                                                                                                                                                                               
	%Put | Produce summary check list.						|;                                                                                                                                                                                                                     
	%Put | Dataset	: &dsDetails.									|;                                                                                                                                                                                                                        
	%Put |........................................|;                                                                                                                                                                                                               
	%Put | Started at: &_tmpStamp.;                                                                                                                                                                                                                                
	%Put +----------------------------------------+;                                                                                                                                                                                                               
    %*-- Change version 2.4  [Start] ;                                                                                                                                                                                                                          
    %Let _hasPortfolio_ND = N;                                                                                                                                                                                                                                  
    Proc Sql outobs=1 noprint;                                                                                                                                                                                                                                  
      Select 'Y' into :_hasPortfolio_ND from &dsDetails. where cod_portafoglio_gest="_ND_";                                                                                                                                                                     
    Quit;                                                                                                                                                                                                                                                       
    %*-- Change version 2.4  [End] ;                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
	%*-- Change version 2.3;                                                                                                                                                                                                                                       
	%Let _hasPortfolio=Y;                                                                                                                                                                                                                                          
	%*-- Change version 1.0, get distinct portfolio;                                                                                                                                                                                                               
	%*-- Start Change;                                                                                                                                                                                                                                             
	%Let _raccordoTotale = datistg.ALL_RECONNECTION_TABLE;                                                                                                                                                                                                         
	%If %sysfunc(exist(&_raccordoTotale.)) %Then %Do;                                                                                                                                                                                                              
		Proc Sql;                                                                                                                                                                                                                                                     
			Create Table _LIST_PORTAFOGLI As                                                                                                                                                                                                                             
					Select cod_istituto as cod_ist                                                                                                                                                                                                                             
                          ,dta_riferimento as dta_reference format=date9.                                                                                                                                                                                       
                          ,cod_portafoglio_gest                                                                                                                                                                                                                 
                          ,des_portafoglio_gest                                                                                                                                                                                                                 
                          ,count(distinct cod_rapporto) as nRapporti                                                                                                                                                                                            
						From &_raccordoTotale.                                                                                                                                                                                                                                    
						where dta_riferimento = "&dta_reference."d                                                                                                                                                                                                                
					Group By 1,2,3,4                                                                                                                                                                                                                                           
				;                                                                                                                                                                                                                                                           
	        %*-- Change version 2.3;                                                                                                                                                                                                                               
			%if &sqlObs.<=0 %then %do;                                                                                                                                                                                                                                   
	          %Let _hasPortfolio=N;                                                                                                                                                                                                                                
			%end;                                                                                                                                                                                                                                                        
            %*-- Change versione 2.4 [Start] ;                                                                                                                                                                                                                  
			%if &_hasPortfolio_ND.=Y %then %do;                                                                                                                                                                                                                          
			  Insert into _LIST_PORTAFOGLI (cod_ist,dta_reference,cod_portafoglio_gest,des_portafoglio_gest)                                                                                                                                                             
                 %If %symExist(cod_ist) %Then %Do;                                                                                                                                                                                                              
                   values(&cod_ist.,"&dta_reference."d,"_ND_","PORTAFOGLIO NON TROVATO");                                                                                                                                                                       
                 %End;                                                                                                                                                                                                                                          
                 %Else %Do;                                                                                                                                                                                                                                     
                   values(.,"&dta_reference."d,"_ND_");                                                                                                                                                                                                         
                 %End;                                                                                                                                                                                                                                          
             %end;                                                                                                                                                                                                                                              
             %*-- Change versione 2.4 [End] ;                                                                                                                                                                                                                   
		Quit;                                                                                                                                                                                                                                                         
	%End;                                                                                                                                                                                                                                                          
	%Else %Do;                                                                                                                                                                                                                                                     
		%*--[versions	: 2.2] -- [Start];                                                                                                                                                                                                                              
		Proc Sql;                                                                                                                                                                                                                                                     
			Create Table _LIST_PORTAFOGLI As                                                                                                                                                                                                                             
					Select                                                                                                                                                                                                                                                     
						%If %symexist(cod_ist) %Then %Do;                                                                                                                                                                                                                         
							cod_istituto as cod_ist                                                                                                                                                                                                                                  
						%end;                                                                                                                                                                                                                                                     
						%Else %Do;                                                                                                                                                                                                                                                
							. as cod_ist                                                                                                                                                                                                                                             
						%End;                                                                                                                                                                                                                                                     
								,"&dta_reference."d as dta_reference                                                                                                                                                                                                                    
							 	 ,cod_portafoglio_gest                                                                                                                                                                                                                                 
								 ,des_portafoglio_gest                                                                                                                                                                                                                                  
								 ,count(*) as nRecords                                                                                                                                                                                                                                  
						From &dsDetails.                                                                                                                                                                                                                                          
					Group By 1,2,3,4                                                                                                                                                                                                                                           
				;                                                                                                                                                                                                                                                           
		Quit;                                                                                                                                                                                                                                                         
		%*--[versions	: 2.2] -- [End];                                                                                                                                                                                                                                
	%End;                                                                                                                                                                                                                                                          
	/*%Let _nrecord=0;*/                                                                                                                                                                                                                                           
	%*-- Change version 2.1: calculate distinc records [start] ;                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
    %*-- Change version 2.3;                                                                                                                                                                                                                                    
    %if &_hasPortfolio.=N %then %do;                                                                                                                                                                                                                            
       %log(level=E, msg=No portfolio have been extracted for &dta_reference., returnCode=255, debug=&debug_mode.);                                                                                                                                             
	   %Let _runCheckList = STOP;                                                                                                                                                                                                                                  
	   %goto uscita;                                                                                                                                                                                                                                               
    %end;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
	%If %sysfunc(exist(&dsDetails.)) %Then %Do;                                                                                                                                                                                                                    
		Proc Sql noprint;                                                                                                                                                                                                                                             
			/*Select Count(distinct idRecord) Into :_nrecord from &dsDetails.;*/                                                                                                                                                                                         
			Create Table _recordPort As                                                                                                                                                                                                                                  
				Select cod_portafoglio_gest                                                                                                                                                                                                                                 
							 ,count(distinct idRecord) as _nrecord                                                                                                                                                                                                                   
					From  &dsDetails.                                                                                                                                                                                                                                          
					Group by 1                                                                                                                                                                                                                                                 
					;                                                                                                                                                                                                                                                          
		Quit;                                                                                                                                                                                                                                                         
		/*%Put &=_nrecord;*/                                                                                                                                                                                                                                          
	%End;                                                                                                                                                                                                                                                          
		%*-- Change version 2.1: calculate distinc records [end] ;                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
	%*-- Change version 1.0, Insert in temporary histChecks all idRule about idAmbito                                                                                                                                                                              
			 to be assign to all portfolio;                                                                                                                                                                                                                              
	%*-- Start Change;                                                                                                                                                                                                                                             
	Data _null_;                                                                                                                                                                                                                                                   
			Retain idAmbito "&idAmbito.";                                                                                                                                                                                                                                
			%hx_declare_ht_historical_check();                                                                                                                                                                                                                           
			%*-- Get descr ambito;                                                                                                                                                                                                                                       
			Declare hash htMtdA(dataset:"&dsMTD. (Rename=(id_ambito=idAmbito Ambito=descr_ambito))",ordered:'y');                                                                                                                                                        
					htMtdA.defineKey("idAmbito");                                                                                                                                                                                                                              
					htMtdA.defineData("descr_ambito");                                                                                                                                                                                                                         
					htMtdA.defineDone();                                                                                                                                                                                                                                       
			%*-- Hash table in order to retrieve descrizione_del_controllo;                                                                                                                                                                                              
			Declare hash htMtdR(dataset:"&dsMTD. (Rename=(Descrizione_del_controllo=descr_rule))",ordered:'y');                                                                                                                                                          
					htMtdR.defineKey("idRule");                                                                                                                                                                                                                                
					htMtdR.defineData("descr_rule","principio");                                                                                                                                                                                                               
					htMtdR.defineDone();                                                                                                                                                                                                                                       
			%*-- Hash table in order to retrieve technical fields;                                                                                                                                                                                                       
			Attrib campoTecnico Length=$40;                                                                                                                                                                                                                              
			Declare hash htCT(dataset:"&_dsFxCampiTecn. (Where=(useCampo='FX'))",ordered:'y',multidata:'yes');                                                                                                                                                           
							htCT.defineKey("idRule");                                                                                                                                                                                                                                
							htCT.defineData("campotecnico");                                                                                                                                                                                                                         
							htCT.defineDone();                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
			%*-- Change version 2.1: create hash table containing portfolio records [start] ;                                                                                                                                                                            
			Declare hash htRec(dataset:"_recordPort (Rename=(_nrecord=nrecTotal))",ordered:'yes');                                                                                                                                                                       
				htRec.defineKey("cod_portafoglio_gest");                                                                                                                                                                                                                    
				htRec.definedata("nrecTotal");                                                                                                                                                                                                                              
				htRec.defineDone();                                                                                                                                                                                                                                         
			%*-- Change version 2.1: create hash table containing portfolio records [end] ;                                                                                                                                                                              
                                                                                                                                                                                                                                                                
			Retain  tableName descr_ambito ' ' nrecTotal 0 nvarsTotal nrecPerimeter 0;                                                                                                                                                                                   
			tableName  = Strip(Symget("dsDetails")); %*-- Declared in hx_run_check_list macro;                                                                                                                                                                           
			nvarsTotal = hx_get_nvars(tableName);                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                
			Call Missing(descr_ambito);                                                                                                                                                                                                                                  
			_rc = htMtdA.find(key:idAmbito);                                                                                                                                                                                                                             
			descr_ambito = propcase(descr_ambito);                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
			_dsFX = Open("&_dsFxTrace.");                                                                                                                                                                                                                                
			%If %sysfunc(exist(_LIST_PORTAFOGLI)) %Then %Do;                                                                                                                                                                                                             
				_dsPort = Open("_LIST_PORTAFOGLI");                                                                                                                                                                                                                         
				Do While (fetch(_dsPort)=0);                                                                                                                                                                                                                                
					cod_ist 						 = getvarn(_dsPort,varnum(_dsPort,"cod_ist"));                                                                                                                                                                                               
					dta_reference 			 = getvarn(_dsPort,varnum(_dsPort,"dta_reference"));                                                                                                                                                                                      
					cod_portafoglio_gest = getvarc(_dsPort,varnum(_dsPort,"cod_portafoglio_gest"));                                                                                                                                                                            
					des_portafoglio_gest = getvarc(_dsPort,varnum(_dsPort,"des_portafoglio_gest"));                                                                                                                                                                            
					rc = rewind(_dsFx);                                                                                                                                                                                                                                        
			%End;                                                                                                                                                                                                                                                        
			%Else %Do;                                                                                                                                                                                                                                                   
				Call Missing(cod_portafoglio_gest,des_portafoglio_gest);                                                                                                                                                                                                    
			%End;                                                                                                                                                                                                                                                        
				%*-- Get number of records;                                                                                                                                                                                                                                 
				nrecTotal = 0;                                                                                                                                                                                                                                              
				_rc       = htRec.find(key:cod_portafoglio_gest);                                                                                                                                                                                                           
				Do While (fetch(_dsFX)=0);                                                                                                                                                                                                                                  
					idRule 	  								 = getvarc(_dsFX,varnum(_dsFX,"idRule"));                                                                                                                                                                                                
					fx_name										 = getvarc(_dsFX,varnum(_dsFX,"FxName"));                                                                                                                                                                                                 
					Perimetro_di_applicabilita = getvarc(_dsFX,varnum(_dsFX,"perimeter"));                                                                                                                                                                                     
					eseguito									 = 'N';                                                                                                                                                                                                                                   
					nota											 = "Missing data";                                                                                                                                                                                                                          
					%*-- Compone List of Technical Fields;                                                                                                                                                                                                                     
					_sep = ' ';                                                                                                                                                                                                                                                
					Call Missing(Campi_Tecnici,campoTecnico);                                                                                                                                                                                                                  
					_flgCheckCT = ifc(htCT.find(key:idRule)=0,'Y','N');                                                                                                                                                                                                        
					Do While (_flgCheckCT='Y');                                                                                                                                                                                                                                
						Campi_Tecnici = Strip(Campi_Tecnici)||_sep||Strip(campoTecnico);                                                                                                                                                                                          
						_sep 					= ',';                                                                                                                                                                                                                                          
						_flgCheckCT 	= ifc(htCT.find_next(key:idRule)=0,'Y','N');                                                                                                                                                                                                 
					End;                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
					_idRule   		= prxchange("s/[ \,\:\;\-\!\@\#\{\}\[\]\(\)\^\$\.\|\*\+\?\\\/\=\%\&]/_/",-1,Compress(idRule));                                                                                                                                                 
					flagName  		= catx('_',"flgidRule",_idRule);                                                                                                                                                                                                               
					nrecPerimeter = 0;                                                                                                                                                                                                                                         
					nOccurs       = 0;                                                                                                                                                                                                                                         
					%*-- Get principio and rule description about idRule;                                                                                                                                                                                                      
					Call Missing(principio,descr_rule);                                                                                                                                                                                                                        
					rc 		= htMtdR.find(key:idRule);                                                                                                                                                                                                                            
				  _rcHT = ht.check(key:idTransaction,key:dataProvider,key:cod_ist,key:dta_reference,key:cod_portafoglio_gest,key:idAmbito,key:idRule);                                                                                                                      
					If _rcHT ^= 0 Then                                                                                                                                                                                                                                         
						_rcHt = ht.add();                                                                                                                                                                                                                                         
				End;                                                                                                                                                                                                                                                        
			%If %sysfunc(exist(_LIST_PORTAFOGLI)) %Then %Do;                                                                                                                                                                                                             
			End; %*-- Close _LIST_PORTAFOGLI;                                                                                                                                                                                                                            
				_dsPort = close(_dsPort);                                                                                                                                                                                                                                   
			%End;                                                                                                                                                                                                                                                        
			_dsFx   = close(_dsFx);                                                                                                                                                                                                                                      
			_rcHt = ht.output(dataset:"&dsHistCheck.");                                                                                                                                                                                                                  
	Run;                                                                                                                                                                                                                                                           
	%*-- Change version 1.0;                                                                                                                                                                                                                                       
	%*-- End Change;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
	Data _null_;                                                                                                                                                                                                                                                   
		/*set &dsDetails.;*/                                                                                                                                                                                                                                          
		Attrib _idRule Length=$200                                                                                                                                                                                                                                    
				;                                                                                                                                                                                                                                                           
		Retain idAmbito "&idAmbito.";                                                                                                                                                                                                                                 
		/*If _N_=1 Then Do;*/                                                                                                                                                                                                                                         
			%*-- Define Attrib and hash table named HT containing temporary histchecks;                                                                                                                                                                                  
			%hx_declare_ht_historical_check(htTable=&dsHistCheck.);                                                                                                                                                                                                      
			/* Change versions 1.1, following declare hash tables are not necessary                                                                                                                                                                                      
			%*-- Get descr ambito;                                                                                                                                                                                                                                       
			Declare hash htMtdA(dataset:"&dsMTD. (Rename=(id_ambito=idAmbito Ambito=descr_ambito))",ordered:'y');                                                                                                                                                        
					htMtdA.defineKey("idAmbito");                                                                                                                                                                                                                              
					htMtdA.defineData("descr_ambito");                                                                                                                                                                                                                         
					htMtdA.defineDone();                                                                                                                                                                                                                                       
			%*-- Hash table in order to retrieve descrizione_del_controllo;                                                                                                                                                                                              
			Declare hash htMtdR(dataset:"&dsMTD. (Rename=(Descrizione_del_controllo=descr_rule))",ordered:'y');                                                                                                                                                          
					htMtdR.defineKey("idRule");                                                                                                                                                                                                                                
					htMtdR.defineData("descr_rule","principio");                                                                                                                                                                                                               
					htMtdR.defineDone();                                                                                                                                                                                                                                       
			%*-- Hash table in order to retrieve technical fields;                                                                                                                                                                                                       
			Attrib campoTecnico Length=$40;                                                                                                                                                                                                                              
			Declare hash htCT(dataset:"&_dsFxCampiTecn. (Where=(useCampo='FX'))",ordered:'y',multidata:'yes');                                                                                                                                                           
					htCT.defineKey("idRule");                                                                                                                                                                                                                                  
					htCT.defineData("campotecnico");                                                                                                                                                                                                                           
					htCT.defineDone();                                                                                                                                                                                                                                         
			Retain  tableName descr_ambito ' ' nrecTotal nvarsTotal .;                                                                                                                                                                                                   
			*/                                                                                                                                                                                                                                                           
			%*- Change versions 1.1, following declare hash tables are not necessary;                                                                                                                                                                                    
			/*                                                                                                                                                                                                                                                           
			tableName 	 = Strip(Symget("dsTarget")); %*-- Declared in hx_run_check_list macro;                                                                                                                                                                           
			nrecTotal    = 0;                                                                                                                                                                                                                                            
			nvarsTotal	 = 0;                                                                                                                                                                                                                                             
			If exist(tableName) Then Do;                                                                                                                                                                                                                                 
				nrecTotal	 = hx_get_nobs(tableName);                                                                                                                                                                                                                        
				nvarsTotal = hx_get_nvars(tableName);                                                                                                                                                                                                                       
			End;                                                                                                                                                                                                                                                         
			*/                                                                                                                                                                                                                                                           
			/* Change versions 1.1, following statments are not necessary                                                                                                                                                                                                
				rc 					 = htMtdA.find(key:idAmbito); %*-- IdAmbito variable of details checks;                                                                                                                                                                             
				descr_ambito = propcase(descr_ambito);                                                                                                                                                                                                                      
			*/                                                                                                                                                                                                                                                           
		/*End;*/                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
		_dsFX = Open("&_dsFxTrace.");                                                                                                                                                                                                                                 
		_dsid = open("&dsDetails.");                                                                                                                                                                                                                                  
		Do While (fetch(_dsid)=0);                                                                                                                                                                                                                                    
			*-idTransaction				 = getvarC(_dsid,varnum(_dsid,"idTransaction"));                                                                                                                                                                                          
			Call Missing(cod_ist);                                                                                                                                                                                                                                       
			If varnum(_dsid,"cod_istituto")>0 Then                                                                                                                                                                                                                       
				cod_ist = getvarN(_dsid,varnum(_dsid,"cod_istituto"));                                                                                                                                                                                                      
			dta_reference  			 = getvarN(_dsid,varnum(_dsid,"dta_riferimento"));                                                                                                                                                                                         
			Call Missing(cod_portafoglio_gest,des_portafoglio_gest);                                                                                                                                                                                                     
			If varnum(_dsid,"cod_portafoglio_gest")>0 Then                                                                                                                                                                                                               
				cod_portafoglio_gest = getvarC(_dsid,varnum(_dsid,"cod_portafoglio_gest"));                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
			%*-- STEP1: Put in memory all idRule regarding idAmbito;                                                                                                                                                                                                     
			rc = rewind(_dsFX);                                                                                                                                                                                                                                          
			Do While (fetch(_dsFX)=0);                                                                                                                                                                                                                                   
				idRule 	  								 = getvarc(_dsFX,varnum(_dsFX,"idRule"));                                                                                                                                                                                                 
*				fx_name										 = getvarc(_dsFX,varnum(_dsFX,"FxName"));                                                                                                                                                                                                 
*				Perimetro_di_applicabilita = getvarc(_dsFX,varnum(_dsFX,"perimeter"));                                                                                                                                                                                     
                                                                                                                                                                                                                                                                
				%*-- Compone List of Technical Fields;                                                                                                                                                                                                                      
				/* Change versions 1.1, following statments are not necessary                                                                                                                                                                                               
				_sep = ' ';                                                                                                                                                                                                                                                 
				Call Missing(Campi_Tecnici,campoTecnico);                                                                                                                                                                                                                   
				_flgCheckCT = ifc(htCT.find(key:idRule)=0,'Y','N');                                                                                                                                                                                                         
				Do While (_flgCheckCT='Y');                                                                                                                                                                                                                                 
					Campi_Tecnici = Strip(Campi_Tecnici)||_sep||Strip(campoTecnico);                                                                                                                                                                                           
					_sep 					= ',';                                                                                                                                                                                                                                           
		  		_flgCheckCT 	= ifc(htCT.find_next(key:idRule)=0,'Y','N');                                                                                                                                                                                                 
				End;                                                                                                                                                                                                                                                        
				%*-- Get principio about idRule;                                                                                                                                                                                                                            
				Call Missing(principio);                                                                                                                                                                                                                                    
				rc 		= htMtdR.find(key:idRule);                                                                                                                                                                                                                             
				*/                                                                                                                                                                                                                                                          
			  %*-- Summarize violation;                                                                                                                                                                                                                                  
				_idRule   		= prxchange("s/[ \,\:\;\-\!\@\#\{\}\[\]\(\)\^\$\.\|\*\+\?\\\/\=\%\&]/_/",-1,Compress(idRule));                                                                                                                                                  
				flagName  		= catx('_',"flgidRule",_idRule);                                                                                                                                                                                                                
				flagPerim 		= catx('_',"inperim",_idRule);                                                                                                                                                                                                                  
				nrecPerimeter = 0;                                                                                                                                                                                                                                          
				nOccurs       = 0;                                                                                                                                                                                                                                          
				If varnum(_dsid,flagPerim)>0 Then                                                                                                                                                                                                                           
					nrecPerimeter	= ifn(getvarN(_dsid,varnum(_dsid,flagPerim)),1,0);                                                                                                                                                                                           
				If varnum(_dsid,flagName)>0 Then                                                                                                                                                                                                                            
					nOccurs				= ifn(getvarC(_dsid,varnum(_dsid,flagName))='Y',1,0);                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
				/*  Change versions 1.1, following statments are not necessary                                                                                                                                                                                              
				_rcHT = ht.check(key:idTransaction,key:dataProvider,key:cod_ist,key:dta_reference,key:cod_portafoglio_gest,key:idAmbito,key:idRule);                                                                                                                        
				If _rcHT ^= 0 Then                                                                                                                                                                                                                                          
					_rcHt = ht.add();                                                                                                                                                                                                                                          
				Else Do;                                                                                                                                                                                                                                                    
				*/                                                                                                                                                                                                                                                          
				_nrecPerimeter  = nrecPerimeter;                                                                                                                                                                                                                            
				_nOccurs        = nOccurs;                                                                                                                                                                                                                                  
				Call Missing(nrecPerimeter,nOccurs);                                                                                                                                                                                                                        
				_rcHt = ht.find(key:idTransaction,key:dataProvider,key:cod_ist,key:dta_reference,key:cod_portafoglio_gest,key:idAmbito,key:idRule);                                                                                                                         
				If varnum(_dsid,"des_portafoglio_gest")>0 And cod_portafoglio_gest="_ND_" Then                                                                                                                                                                              
					des_portafoglio_gest = getvarC(_dsid,varnum(_dsid,"des_portafoglio_gest"));                                                                                                                                                                                
                                                                                                                                                                                                                                                                
				eseguito		  = getvarc(_dsFX,varnum(_dsFX,"flgExecuteFx"));                                                                                                                                                                                                  
				nota				  = getvarc(_dsFX,varnum(_dsFX,"PerformNote"));                                                                                                                                                                                                     
				nrecPerimeter = sum(nrecPerimeter,_nrecPerimeter);                                                                                                                                                                                                          
				nOccurs       = sum(nOccurs,_nOccurs);                                                                                                                                                                                                                      
				_rcHt         = ht.replace();                                                                                                                                                                                                                               
				*-- End;                                                                                                                                                                                                                                                    
			End; %*-- Fine ciclo on Function;                                                                                                                                                                                                                            
		End; %*-- Fine ciclo on Details checks;                                                                                                                                                                                                                       
		_dsid = Close(_dsid);                                                                                                                                                                                                                                         
		_dsFX = Close(_dsFX);                                                                                                                                                                                                                                         
		_rcHt = ht.output(dataset:"&dsHistCheck.");                                                                                                                                                                                                                   
	Run;                                                                                                                                                                                                                                                           
	%Uscita:                                                                                                                                                                                                                                                       
		%Let _tmpStamp = %sysfunc(putn(%sysfunc(datetime()),datetime.));                                                                                                                                                                                              
		%Put +---[Macro: &sysmacroname.] -------------+;                                                                                                                                                                                                              
		%Put | Produce details check list.						|;                                                                                                                                                                                                                    
		%Put | Dataset	: &dsDetails.									|;                                                                                                                                                                                                                       
		%Put |........................................|;                                                                                                                                                                                                              
		%Put | Ended at: &_tmpStamp.;                                                                                                                                                                                                                                 
		%Put +----------------------------------------+;                                                                                                                                                                                                              
%Mend;                                                                                                                                                                                                                                                          
*Options Nomprint;                                                                                                                                                                                                                                              
/*                                                                                                                                                                                                                                                              
%Let _libout 				= datichk;                                                                                                                                                                                                                                     
%Let _dsOutChecks 	= DWH_COUNTERPARTIES;                                                                                                                                                                                                                        
%Let idAmbito				= A;                                                                                                                                                                                                                                           
%Let dsTarget				= datistg.DWH_COUNTERPARTIES;                                                                                                                                                                                                                  
%Let _dsFxTrace			= datiLkp._ListFunzioni;                                                                                                                                                                                                                      
%Let dsMTD					= prvmeta.DWH_tassonomia_controlli;                                                                                                                                                                                                              
%Let dataProvider		= DWH;                                                                                                                                                                                                                                       
%Let _dsFxCampiTecn = datiLkp._ListCampiTecnici;                                                                                                                                                                                                                
%Let metaFolder = %UnQuote(&projectFolder.)&slash.02_Metadati&slash.&dataProvider.&slash.Tabledata;                                                                                                                                                             
Libname prvmeta	"&metaFolder.";                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
Proc Sql;                                                                                                                                                                                                                                                       
		Create Table work.histChecks Like &histchecks.;                                                                                                                                                                                                               
Quit;                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
%hx_summary_checklist(dsDetails=&_libout..&_dsOutChecks.,dsHistCheck=work.histChecks);                                                                                                                                                                          
                                                                                                                                                                                                                                                                
Proc Sql;                                                                                                                                                                                                                                                       
	Create Table _histSummary As                                                                                                                                                                                                                                   
		Select idRule                                                                                                                                                                                                                                                 
					 ,cod_portafoglio_gest                                                                                                                                                                                                                                     
					 ,sum(nrecPerimeter) as nrecPerimeter                                                                                                                                                                                                                      
					 ,sum(nOccurs) as nOccurs                                                                                                                                                                                                                                  
			From work.histChecks                                                                                                                                                                                                                                         
		Group by 1,2                                                                                                                                                                                                                                                  
	;                                                                                                                                                                                                                                                              
Quit;                                                                                                                                                                                                                                                           
*/                                                                                                                                                                                                                                                              
