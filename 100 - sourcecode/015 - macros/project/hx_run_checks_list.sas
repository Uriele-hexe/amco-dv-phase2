*==================================================================================================                                                                                                                                                             
* Cliente : AMCO SpA                                                                                                                                                                                                                                            
* Office  : CRO Portfolio Managment -> Data Verification                                                                                                                                                                                                        
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Macro name  : dwh_apply_dq_garanzie                                                                                                                                                                                                                           
* Description : Execute list of checks regarding ambito garanzie. In addition macro can just extract                                                                                                                                                            
*								technical fields.                                                                                                                                                                                                                                      
* Author      : Uriele De Piano Hexe SpA, 25 November 2020                                                                                                                                                                                                      
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Parameter:                                                                                                                                                                                                                                                    
*    	1) Ambito                                                                                                                                                                                                                                                 
*		 	2) Data Table                                                                                                                                                                                                                                              
*			3) Metadata Name                                                                                                                                                                                                                                            
*			4) Flag extraction just tecnichal fields (set on YES)                                                                                                                                                                                                       
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* Output                                                                                                                                                                                                                                                        
*  - Dataset defined into metadata that describe lookup                                                                                                                                                                                                         
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* NOTE: Il programma esegue i checks sulla nuova struttura dei Metadati che dovr√† essere applicata                                                                                                                                                             
*		    con la fase 2 dei controlli                                                                                                                                                                                                                              
* -------------------------------------------------------------------------------------------------                                                                                                                                                             
* History Change                                                                                                                                                                                                                                                
*   Code        : hist_checks                                                                                                                                                                                                                                   
*		Description : Creation of historical checks regarding both LDT checks or DWH Checks                                                                                                                                                                          
*		Date        : 10 December 2020                                                                                                                                                                                                                               
*		Author      : Uriele De Piano Hexe SpA                                                                                                                                                                                                                       
* .................................................................................................                                                                                                                                                             
*   Code        : zero-rec                                                                                                                                                                                                                                      
*		Description : If the source data contains no observations, the checklist will not be applied                                                                                                                                                                 
*		Date        : 10 December 2020                                                                                                                                                                                                                               
*		Author      : Uriele De Piano Hexe SpA                                                                                                                                                                                                                       
* .................................................................................................                                                                                                                                                             
*   Code        : portf                                                                                                                                                                                                                                         
*		Description : Check existence of cod_portafoglio_gest and des_portafoglio_gest                                                                                                                                                                               
*		Date        : 13 January 2021                                                                                                                                                                                                                                
*		Author      : Uriele De Piano Hexe SpA                                                                                                                                                                                                                       
* .................................................................................................                                                                                                                                                             
*   Code        : portf2                                                                                                                                                                                                                                        
*		Description : Use cod_portafoglio_gest e des_portafoglio_gest to summarrize violation                                                                                                                                                                        
*		Date        : 13 January 2021                                                                                                                                                                                                                                
*		Author      : Uriele De Piano Hexe SpA                                                                                                                                                                                                                       
*==================================================================================================                                                                                                                                                             
;                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
%Macro hx_run_checks_list(idAmbito=_NULL_,dsTarget=_NULL_,dsMTD=_NULL_,flgOnlyCt=NO ) / store secure ;                                                                                                                                                          
	%Local _tmpStamp _wclsClause _tableTrace _dsFx _dsFxTrace _dsFxCampiTecn _idRule _idAMbito _fxName                                                                                                                                                             
			   _campoTecnico _campiTecnici _flgExecutePer _dsOutChecks _flgCode _libout                                                                                                                                                                                  
				 _wclsDeleteBeforeApp _wclsDeleteHist _hasZeroRecord                                                                                                                                                                                                        
			;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
	%let _tableTrace 		= &processTrace;                                                                                                                                                                                                                            
	%*-- NOTE: _dsFxtrace and _dsFxCampiTecn created and update by Hash Table method;                                                                                                                                                                              
	%Let _dsFxTrace			= work._ListFunzioni;                                                                                                                                                                                                                        
	%Let _dsFxCampiTecn = work._ListCampiTecnici;                                                                                                                                                                                                                  
	%Let _libOut				= datichk;                                                                                                                                                                                                                                     
	%Let _wclsDeleteBeforeApp=1;                                                                                                                                                                                                                                   
	%If %symExist(cod_ist) %Then %Do;                                                                                                                                                                                                                              
		%Let _wclsDeleteBeforeApp = %NrQuote(cod_ist = &cod_ist.);                                                                                                                                                                                                    
	%End;                                                                                                                                                                                                                                                          
	%Let _wclsDeleteBeforeApp = %NrQuote(&_wclsDeleteBeforeApp. And idAmbito="&idAmbito." And idTransaction = Strip%("&idTrasaction."%) And DataProvider In %("CMN","&dataProvider."%) And dta_reference="&dta_reference."d);                                      
                                                                                                                                                                                                                                                                
	%If %sysfunc(exist(&_dsFxTrace.)) %Then %Do;                                                                                                                                                                                                                   
		Proc Sql;                                                                                                                                                                                                                                                     
			Drop Table &_dsFxTrace.;                                                                                                                                                                                                                                     
		Quit;                                                                                                                                                                                                                                                         
	%End;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
	%If %sysfunc(exist(&_dsFxCampiTecn.)) %Then %Do;                                                                                                                                                                                                               
		Proc Sql;                                                                                                                                                                                                                                                     
			Drop Table &_dsFxCampiTecn.;                                                                                                                                                                                                                                 
		Quit;                                                                                                                                                                                                                                                         
	%End;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
	%Let _tmpStamp = %sysfunc(putn(%sysfunc(datetime()),datetime.));                                                                                                                                                                                               
	%Put +---[Macro: &sysmacroname.] -------------+;                                                                                                                                                                                                               
	%Put | Execute list of checks on &dsTarget.		|;                                                                                                                                                                                                                
	%Put | idAmbito	: &idAmbito.									|;                                                                                                                                                                                                                        
	%Put | Metadata	: &dsMtd.											|;                                                                                                                                                                                                                         
	%Put |........................................|;                                                                                                                                                                                                               
	%Put | Started at: &_tmpStamp.;                                                                                                                                                                                                                                
	%Put +----------------------------------------+;                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
	%If %sysfunc(exist(&dsTarget.))=0 %Then %Do;                                                                                                                                                                                                                   
 	 %log(level = W, msg = &dsTarget. not exists);                                                                                                                                                                                                                
   %*return;                                                                                                                                                                                                                                                    
	%End;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
	%If %sysfunc(exist(&dsMTD.))=0 %Then %Do;                                                                                                                                                                                                                      
 	 %log(level = E, msg = &dsMTD. not exists);                                                                                                                                                                                                                   
   %return;                                                                                                                                                                                                                                                     
	%End;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
	%*-- Where clause to apply at metadata tassonomia checks;                                                                                                                                                                                                      
	%Let _wclsClause=%NrQuote(id_Ambito="&idAmbito." /*And Data_Provider In %("CMN","%Upcase(&dataProvider.)"%)*/ And Not missing%(Data_Rilascio %));                                                                                                              
	%If %symexist(dta_reference) %Then %Do;                                                                                                                                                                                                                        
		%Let _wclsClause=%NrQuote(&_wclsClause. And %(Data_Validita_From <= "&dta_reference."d And Data_validita_To >= "&dta_reference."d%));                                                                                                                         
	%End;                                                                                                                                                                                                                                                          
	/*                                                                                                                                                                                                                                                             
	%Put &=_wclsClause;                                                                                                                                                                                                                                            
*/                                                                                                                                                                                                                                                              
  %*-- If the same rule exists for both CMN and Provider, the next datastep only keeps the one of the provider;                                                                                                                                                 
	Proc Sql;                                                                                                                                                                                                                                                      
		Create Table _metaCheckRueles As                                                                                                                                                                                                                              
			Select *                                                                                                                                                                                                                                                     
			  From &dsMTD.                                                                                                                                                                                                                                               
			Where &_wclsClause.                                                                                                                                                                                                                                          
		Order By data_provider,id_Ambito,idRule                                                                                                                                                                                                                       
			;                                                                                                                                                                                                                                                            
	Quit;                                                                                                                                                                                                                                                          
	%If &sqlObs.<=0 %Then %Do;                                                                                                                                                                                                                                     
	 	 %log(level = E, msg = &dsMTD. no records for &_wclsClause.);                                                                                                                                                                                                
		%Return;                                                                                                                                                                                                                                                      
	%End;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
  %log(level = N, msg = ----------------------------);                                                                                                                                                                                                          
  %log(level = N, msg =   Check tecnical fields     );                                                                                                                                                                                                          
  %log(level = N, msg = ----------------------------);                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
	Data _null_ /*(Keep=idTransaction dataProvider timeStamp IdAmbito IdRule Principio campoTecnico TipoCheck dtaValid_from dtaValid_to)*/;                                                                                                                        
		Attrib  dataProvider	Length=$15		Label="Data Provider"                                                                                                                                                                                                        
						cod_ist				Length=8			Label="Istitute"                                                                                                                                                                                                                    
						dta_reference Length=8			Label="Reference date" format=ddmmyy10.                                                                                                                                                                                          
					  idTransaction Length=$25  	Label="Id. transaction"                                                                                                                                                                                                       
						timeStamp			Length=8			Label="Timestamp" format=Datetime.                                                                                                                                                                                                 
						IdAmbito			Length=$40		Label="Id. Ambito"                                                                                                                                                                                                                 
						targetTable		Length=$40		Label="Data table name"                                                                                                                                                                                                          
						metaTable			Length=$40		Label="Metadata Name"                                                                                                                                                                                                             
						wclsMeta			Length=$256		Label="Metadata where clause"                                                                                                                                                                                                     
						IdRule				Length=$40		Label="Id. Rule"                                                                                                                                                                                                                    
						campoTecnico	Length=$80		Label="Campo Tecnico"                                                                                                                                                                                                            
						useCampo			Length=$3			Label="Where Tecnical field will be apply "                                                                                                                                                                                        
						FxName  			Length=$256		Label="Function Name"                                                                                                                                                                                                             
						perimeter			Length=$256		Label="Perimeter within which to apply check"                                                                                                                                                                                    
						dtaRilascio		Length=8	  	Label="Date odf release check" format=date9.                                                                                                                                                                                     
					 	dtaValid_from	Length=8			Label="Valid From" format=date9.                                                                                                                                                                                                
						dtaValid_to		Length=8			Label="Valid To" format=date9.                                                                                                                                                                                                    
						flgInTarget		Length=$1			Label="Field in target table"                                                                                                                                                                                                    
						flgExecuteFx	Length=$1			Label="Function executable Y/N"                                                                                                                                                                                                  
						PerformNote   Length=$4000	Label="Note about perform"                                                                                                                                                                                                     
						flgExecutePer Length=$1			Label="Perimetr applicable Y/N"                                                                                                                                                                                                 
						campiTecnici	Length=$1000	Label="Campi tecnici"                                                                                                                                                                                                           
						applicabile		Length=$1			Label="Applicabilit√†"                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
			;                                                                                                                                                                                                                                                            
		%If %symeXist(cod_ist) %Then %Do;                                                                                                                                                                                                                             
			Retain cod_ist &cod_ist.;                                                                                                                                                                                                                                    
		%End;                                                                                                                                                                                                                                                         
		%If %sysfunc(exist(&_dsFxCampiTecn.)) %Then %Do;                                                                                                                                                                                                              
			Declare hash htCT(dataset:"&_dsFxCampiTecn."                                                                                                                                                                                                                 
									      ,ordered:"yes",multidata:"yes");                                                                                                                                                                                                                 
		%End;                                                                                                                                                                                                                                                         
		%Else %Do;                                                                                                                                                                                                                                                    
			Declare hash htCT(ordered:"yes",multidata:"yes");                                                                                                                                                                                                            
		%End;                                                                                                                                                                                                                                                         
			htCT.definekey("dataProvider","cod_ist","dta_reference","idTransaction","IdAmbito","idRule");                                                                                                                                                                
			htCT.defineData("dataProvider","cod_ist","dta_reference","idTransaction","IdAmbito","idRule","campoTecnico","flgInTarget","useCampo");                                                                                                                       
			htCT.defineDone();                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
		%If %sysfunc(exist(&_dsFxTrace.)) %Then %Do;                                                                                                                                                                                                                  
			Declare hash htFX(dataset:"&_dsFxTrace."                                                                                                                                                                                                                     
									      ,ordered:"yes",multidata:"yes");                                                                                                                                                                                                                 
		%End;                                                                                                                                                                                                                                                         
		%Else %Do;                                                                                                                                                                                                                                                    
			Declare hash htFX(ordered:"yes",multidata:"yes");                                                                                                                                                                                                            
		%End;                                                                                                                                                                                                                                                         
			htFX.definekey("dataProvider","cod_ist","idTransaction","IdAmbito","idRule");                                                                                                                                                                                
			htFX.defineData("dataProvider","cod_ist","idTransaction","IdAmbito","idRule","dtaRilascio","FxName","targetTable"                                                                                                                                            
										 ,"perimeter","flgExecutePer","flgExecuteFx","PerformNote");                                                                                                                                                                                          
			htFX.defineDone();                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
		Length campiTecnici $1000                                                                                                                                                                                                                                     
				;                                                                                                                                                                                                                                                           
    dsChecksTrace = strip(symget("histCtchecks"));                                                                                                                                                                                                              
		targetTable   = strip(symget("dsTarget"));                                                                                                                                                                                                                    
		metaTable     = "_metaCheckRueles";                                                                                                                                                                                                                           
		wclsMeta      = strip(symget("_wclsClause"));                                                                                                                                                                                                                 
		IdAmbito      = strip(symget("IdAmbito"));                                                                                                                                                                                                                    
		dta_reference = "&dta_reference."d;                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
		%*-- Declare hash table regarding process trace;                                                                                                                                                                                                              
		%*-- Macro update idTransactio and timeStamp;                                                                                                                                                                                                                 
		%hx_declare_ht_pr(htTable=&processTrace.);                                                                                                                                                                                                                    
		sourceCode    = symget("sysmacroname");                                                                                                                                                                                                                       
		stepCode      = catx(' ',"Execution of checks about ",IdAmbito,"on",targetTable);                                                                                                                                                                             
		Call Missing(rcCode,msgCode);                                                                                                                                                                                                                                 
		_dsid       = open(metaTable);                                                                                                                                                                                                                                
		If _dsid <=0 Then Do;                                                                                                                                                                                                                                         
			rcCode = -250;                                                                                                                                                                                                                                               
			msgCode = sysmsg();                                                                                                                                                                                                                                          
			Link esci;                                                                                                                                                                                                                                                   
		End;                                                                                                                                                                                                                                                          
		_dsT = 0;                                                                                                                                                                                                                                                     
		If exist(targetTable) Then _dsT = open(targetTable);                                                                                                                                                                                                          
		%*--[Codice modifica: zero-rec] -- Start modify;                                                                                                                                                                                                              
	  /*_hasZeroRecord = ifc(attrn(_dsT,"NOBS")=0,'Y','N');*/                                                                                                                                                                                                      
		_hasZeroRecord='Y';                                                                                                                                                                                                                                           
		If _dsT>0 Then _hasZeroRecord='N';                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
		Do While (fetch(_dsid)=0);                                                                                                                                                                                                                                    
			Call missing(IdAmbito,idRule,dtaRilascio,FxName,perimeter,flgExecutePer,flgExecuteFx,PerformNote);                                                                                                                                                           
			dataProvider  = getvarc(_dsid,varnum(_dsid,"Data_Provider"));                                                                                                                                                                                                
			IdAmbito 			= getvarc(_dsid,varnum(_dsid,"Id_Ambito"));                                                                                                                                                                                                      
			idRule   			= getvarc(_dsid,varnum(_dsid,"idRule"));                                                                                                                                                                                                         
			dtaRilascio   = getvarn(_dsid,varnum(_dsid,"Data_Rilascio"));                                                                                                                                                                                                
			dtaValid_from = getvarN(_dsid,varnum(_dsid,"Data_Validita_From"));                                                                                                                                                                                           
			dtaValid_to		= getvarN(_dsid,varnum(_dsid,"Data_validita_To"));                                                                                                                                                                                              
			campiTecnici  = getvarc(_dsid,varnum(_dsid,"campi_tecnici"));                                                                                                                                                                                                
			FxName				= getvarc(_dsid,varnum(_dsid,"nome_funzione"));                                                                                                                                                                                                    
			perimeter			= getvarc(_dsid,varnum(_dsid,"Perimetro_di_applicabilita"));                                                                                                                                                                                     
			applicabile   = getvarc(_dsid,varnum(_dsid,"Applicabilita_Controllo"));                                                                                                                                                                                      
			PerformNote   = getvarc(_dsid,varnum(_dsid,"Note_Applicabilita"));                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
			flgExecuteFx = 'N';                                                                                                                                                                                                                                          
			If Upcase(applicabile) In ('Y','S') Then Do;                                                                                                                                                                                                                 
				If not exist(targetTable) Then Do;                                                                                                                                                                                                                          
					PerformNote = catx(' ',"Missing source information regarding [",IdAmbito,']');                                                                                                                                                                             
					applicabile = 'N';                                                                                                                                                                                                                                         
				End;                                                                                                                                                                                                                                                        
				Else if _hasZeroRecord='Y' Then Do;                                                                                                                                                                                                                         
					PerformNote = catx(' ',"No record extract from source table [",dsName(_dsT),']');                                                                                                                                                                          
					applicabile = 'Y';                                                                                                                                                                                                                                         
				End;                                                                                                                                                                                                                                                        
				Else if missing(fxName) Then Do;                                                                                                                                                                                                                            
					PerformNote = "Missing function name";                                                                                                                                                                                                                     
					applicabile = 'N';                                                                                                                                                                                                                                         
				End;                                                                                                                                                                                                                                                        
			End;                                                                                                                                                                                                                                                         
			If Upcase(applicabile) In ('Y','S') Then Do;                                                                                                                                                                                                                 
				%*-- Check tecnichal field ad set at Y flag function execution;                                                                                                                                                                                             
				_rc           = Count(campiTecnici,'-');                                                                                                                                                                                                                    
				flgExecuteFx  = ifc(missing(fxName),'N','Y');                                                                                                                                                                                                               
				useCampo      = "FX";                                                                                                                                                                                                                                       
				Do _i=1 To _rc+1;                                                                                                                                                                                                                                           
					campoTecnico = strip(scan(campiTecnici,_i,'-'));                                                                                                                                                                                                           
					if missing(campoTecnico) Then flgInTarget='N';                                                                                                                                                                                                             
					Else flgInTarget  = ifc(varnum(_dsT,campoTecnico)<=0,'N','Y');                                                                                                                                                                                             
					If flgInTarget='N'  Then Do;                                                                                                                                                                                                                               
						flgExecuteFx = 'N';                                                                                                                                                                                                                                       
						If Upcase(applicabile) In ('Y','S') Then                                                                                                                                                                                                                  
							PerformNote  = catx(' ',campoTecnico,"missing in",dsName(_dsT));                                                                                                                                                                                         
					End;                                                                                                                                                                                                                                                       
					rc = htCT.add();                                                                                                                                                                                                                                           
				End;                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                
				%*-- [Change: portf] [Start Modify]--------------------;                                                                                                                                                                                                    
				%If %Upcase(&dataProvider.)=DWH %Then %Do;                                                                                                                                                                                                                  
					useCampo     = "POR";                                                                                                                                                                                                                                      
					campoTecnico = "cod_portafoglio_gest";                                                                                                                                                                                                                     
					flgInTarget  = ifc(varnum(_dsT,campoTecnico)<=0,'N','Y');                                                                                                                                                                                                  
					If flgInTarget = 'Y' Then Do;                                                                                                                                                                                                                              
						campoTecnico = "des_portafoglio_gest";                                                                                                                                                                                                                    
						flgInTarget  = ifc(varnum(_dsT,campoTecnico)<=0,'N','Y');                                                                                                                                                                                                 
					End;                                                                                                                                                                                                                                                       
					If flgInTarget='N'  Then Do;                                                                                                                                                                                                                               
						flgExecuteFx = 'N';                                                                                                                                                                                                                                       
						If Upcase(applicabile) In ('Y','S') Then                                                                                                                                                                                                                  
							PerformNote  = catx(' ',"cod_portafoglio_gest or des_portafoglio_gest are","missing in",dsName(_dsT));                                                                                                                                                   
					End;                                                                                                                                                                                                                                                       
					rc = htCT.add();                                                                                                                                                                                                                                           
				%End;                                                                                                                                                                                                                                                       
				%*-- [Change: portf] [End Modify]--------------------;                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
				%*-- Check existence field of perimeter in order to apply it;                                                                                                                                                                                               
				flgExecutePer = ifc(missing(perimeter),' ','Y');                                                                                                                                                                                                            
				%*-- Count how many # symbols there are in the perimeter. The SAS code expects an even number of this symbol;                                                                                                                                               
				If mod(count(perimeter,'#'),2)=0 Then Do;                                                                                                                                                                                                                   
					useCampo = "PER";                                                                                                                                                                                                                                          
					nVariables = count(perimeter,'#')/2;                                                                                                                                                                                                                       
					Do _var=1 to nVariables;                                                                                                                                                                                                                                   
						campoTecnico = scan(perimeter,_var*2,'#');                                                                                                                                                                                                                
						flgInTarget  = ifc(varnum(_dsT,campoTecnico)<=0,'N','Y');                                                                                                                                                                                                 
						If flgInTarget='N' Then flgExecutePer  = 'N';                                                                                                                                                                                                             
						rc = htCT.add();                                                                                                                                                                                                                                          
					End;                                                                                                                                                                                                                                                       
				End;                                                                                                                                                                                                                                                        
				perimeter = compBl(prxchange("s/[#]/ /",-1,perimeter));                                                                                                                                                                                                     
				If flgExecutePer='N' Then Do;                                                                                                                                                                                                                               
					flgExecuteFx = 'N';                                                                                                                                                                                                                                        
					PerformNote  = catx(' ',"Check the fields in the perimeter. There is at least one field not in",dsName(_dsT));                                                                                                                                             
				End;                                                                                                                                                                                                                                                        
			End;                                                                                                                                                                                                                                                         
			rc = htFx.add();                                                                                                                                                                                                                                             
		End;                                                                                                                                                                                                                                                          
		_dsid   = close(_dsid);                                                                                                                                                                                                                                       
		If _dsT>0 Then _dsT = Close(_dsT);                                                                                                                                                                                                                            
		rcCode  = 1;                                                                                                                                                                                                                                                  
		msgCode = catx(' ',"Preliminary checks applied. See",dsChecksTrace,"for details");                                                                                                                                                                            
		Link esci;                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
		rc = htCT.output(dataset:"&_dsFxCampiTecn.");                                                                                                                                                                                                                 
		rc = htFX.output(dataset:"&_dsFxTrace.");                                                                                                                                                                                                                     
		Return;                                                                                                                                                                                                                                                       
		ESCI:                                                                                                                                                                                                                                                         
			rc = ht.add();                                                                                                                                                                                                                                               
			rc = ht.output(dataset:"&_tableTrace.");                                                                                                                                                                                                                     
		RETURN;                                                                                                                                                                                                                                                       
	Run;                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
	%If %Upcase(&flgOnlyCt.)= YES %Then %Do;                                                                                                                                                                                                                       
		%Return;                                                                                                                                                                                                                                                      
	%End;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
  %log(level = N, msg = ----------------------------);                                                                                                                                                                                                          
  %log(level = N, msg =   Apply function checks     );                                                                                                                                                                                                          
  %log(level = N, msg = ----------------------------);                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
	%*-- Apply function [start code];                                                                                                                                                                                                                              
	%Let _dsOutChecks = %Qscan(&dsTarget.,2,%NrQuote(.));                                                                                                                                                                                                          
	%If %sysfunc(exist(&dsTarget.))=0 %Then %Do;                                                                                                                                                                                                                   
		Data _temp;                                                                                                                                                                                                                                                   
			Attrib cod_portafoglio_gest Length=$5                                                                                                                                                                                                                        
						 des_portafoglio_gest Length=$255                                                                                                                                                                                                                         
						;                                                                                                                                                                                                                                                         
			Retain cod_portafoglio_gest " "                                                                                                                                                                                                                              
				   des_portafoglio_gest " "                                                                                                                                                                                                                                 
			;                                                                                                                                                                                                                                                            
			idRecord = _N_;                                                                                                                                                                                                                                              
			dta_riferimento = "&dta_reference."d;                                                                                                                                                                                                                        
	%End;                                                                                                                                                                                                                                                          
	%Else %Do;                                                                                                                                                                                                                                                     
		Data &_libout..&_dsOutChecks.;                                                                                                                                                                                                                                
	%End;                                                                                                                                                                                                                                                          
	%If %sysfunc(exist(&dsTarget.)) %Then %Do;                                                                                                                                                                                                                     
		Set &dsTarget.;                                                                                                                                                                                                                                               
	%End;                                                                                                                                                                                                                                                          
		%Let _dsFx = %sysfunc(Open(&_dsFxTrace. (Where=(flgExecuteFx='Y'))));                                                                                                                                                                                         
		%Do %While (%sysfunc(fetch(&_dsFX.))=0);                                                                                                                                                                                                                      
			%Let _idRule 	  		= %sysfunc(getvarC(&_dsFx.,%sysfunc(varnum(&_dsFx.,idRule))));                                                                                                                                                                             
			%Let _idAMbito  		= %sysfunc(getvarC(&_dsFx.,%sysfunc(varnum(&_dsFx.,idAmbito))));                                                                                                                                                                           
			%Let _fxName	  		= %Bquote(%sysfunc(getvarC(&_dsFx.,%sysfunc(varnum(&_dsFx.,fxName)))));                                                                                                                                                                     
			%Let _perimeter			= %sysfunc(getvarC(&_dsFx.,%sysfunc(varnum(&_dsFx.,perimeter))));                                                                                                                                                                          
			%Let _flgExecutePer = %sysfunc(getvarC(&_dsFx.,%sysfunc(varnum(&_dsFx.,flgExecutePer))));                                                                                                                                                                    
                                                                                                                                                                                                                                                                
			%Let _campiTecnici = ;                                                                                                                                                                                                                                       
			%Let _sep          =;                                                                                                                                                                                                                                        
			%Let _dsCt     		 = %sysfunc(Open(&_dsFxCampiTecn. (Where=(idRule = "&_idRule." And flgInTarget='Y' And useCampo="FX"))));                                                                                                                                   
			%Do %While (%sysfunc(fetch(&_dsCt.))=0);                                                                                                                                                                                                                     
				%Let _campoTecnico = %sysfunc(getvarC(&_dsCt.,%Sysfunc(varnum(&_dsCt.,campoTecnico))));                                                                                                                                                                     
				%Let _campiTecnici = %NrQuote(&_campiTecnici.&_sep.&_campoTecnico.);                                                                                                                                                                                        
				%Let _sep =,;                                                                                                                                                                                                                                               
			%End;                                                                                                                                                                                                                                                        
			%Let _dsCt 		= %sysfunc(Close(&_dsCt.));                                                                                                                                                                                                                     
			%Let _flgCode = flgidRule_%replace_spec_chars(&_idRule.,char=_);                                                                                                                                                                                             
			%Let _varCasi = inperim_%replace_spec_chars(&_idRule.,char=_);                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
			Attrib &_flgCode. Length=$1. Label="Flag rule.Rule Y not passed"                                                                                                                                                                                             
						 &_varCasi.	Length=8	 Label="N. of cases to be applied"                                                                                                                                                                                                   
						;                                                                                                                                                                                                                                                         
		  &_varCasi.=0;                                                                                                                                                                                                                                               
			%*-- Perimeter contains then do, in it start with if;                                                                                                                                                                                                        
			%If %is_empty(%bquote(&_perimeter.))=0 %Then %Do;                                                                                                                                                                                                            
				%UnQuote(&_perimeter.)                                                                                                                                                                                                                                      
				%if %lowcase(%Qscan(%UnQuote(&_perimeter.),1,%NrQuote( )))=if %Then %Do;                                                                                                                                                                                    
					then do                                                                                                                                                                                                                                                    
				%end;                                                                                                                                                                                                                                                       
				 ;                                                                                                                                                                                                                                                          
			%End;                                                                                                                                                                                                                                                        
				&_varCasi. = 1;                                                                                                                                                                                                                                             
				&_flgCode. = %UnQuote(&_fxName.)(%UnQuote(&_campiTecnici.));                                                                                                                                                                                                
			%If %is_empty(%bquote(&_perimeter.))=0 %Then %Do;                                                                                                                                                                                                            
				End;                                                                                                                                                                                                                                                        
			%End;                                                                                                                                                                                                                                                        
		%End;                                                                                                                                                                                                                                                         
		%Let _dsFx = %sysfunc(Close(&_dsFx.));                                                                                                                                                                                                                        
	Run;                                                                                                                                                                                                                                                           
	%*-- Apply function [end code];                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
	%*-- Update historical checks into temporary table;                                                                                                                                                                                                            
	%If &syserr.<=4 %Then %Do;                                                                                                                                                                                                                                     
		%*-- WARNING: Details check will be created in staging area                                                                                                                                                                                                   
									It should be historicized                                                                                                                                                                                                                              
				;                                                                                                                                                                                                                                                           
		/*%hx_details_checklist(dsDetails=work.&_dsOutChecks.);                                                                                                                                                                                                       
		%hx_update_tabletrace(libnm=datistg,phase=checklist,whrcl=%NrQuote(upcase%(memname%)="%Upcase(&_dsOutChecks.)"));*/                                                                                                                                           
		Proc Sql;                                                                                                                                                                                                                                                     
			Create Table work.histChecks Like &histchecks.;                                                                                                                                                                                                              
		Quit;                                                                                                                                                                                                                                                         
		%If %sysfunc(exist(datistg.&_dsOutChecks.)) %Then %Do;                                                                                                                                                                                                        
			%*-- Use dataset created in datichk library to aggregate results;                                                                                                                                                                                            
			%Let _runCheckList = GO;                                                                                                                                                                                                                                     
			%hx_summary_checklist(dsDetails=&_libout..&_dsOutChecks.,dsHistCheck=work.histChecks);                                                                                                                                                                       
			%If %sysfunc(exist(work.histChecks)) And &_runCheckList.=GO %Then %Do;                                                                                                                                                                                       
				%*-- Historicize results;                                                                                                                                                                                                                                   
				%hx_public_checklist(checksOutput=work.histChecks);                                                                                                                                                                                                         
			%End;                                                                                                                                                                                                                                                        
		%End;                                                                                                                                                                                                                                                         
		%Else %Do;                                                                                                                                                                                                                                                    
			%If %sysfunc(exist(_temp)) %Then %Do;                                                                                                                                                                                                                        
				%*-- Use dataset created in datichk library to aggregate results;                                                                                                                                                                                           
			    %Let _runCheckList = GO;                                                                                                                                                                                                                                 
				%hx_summary_checklist(dsDetails=_temp,dsHistCheck=work.histChecks);                                                                                                                                                                                         
				%If %sysfunc(exist(work.histChecks)) And &_runCheckList.=GO %Then %Do;                                                                                                                                                                                      
					%*-- Historicize results;                                                                                                                                                                                                                                  
					%hx_public_checklist(checksOutput=work.histChecks);                                                                                                                                                                                                        
				%End;                                                                                                                                                                                                                                                       
			%End;                                                                                                                                                                                                                                                        
		%End;                                                                                                                                                                                                                                                         
	%End;                                                                                                                                                                                                                                                          
%Mend;                                                                                                                                                                                                                                                          
/*                                                                                                                                                                                                                                                              
%hx_run_checks_list(idAmbito=A,dsTarget=datiwip.DWH_ANAG_CTP_003,dsMTD=&dsDwhMetaChecks.);                                                                                                                                                                      
%hx_run_checks_list(idAmbito=G,dsTarget=datistg.DWH_GARANZIE,dsMTD=&dsDwhMetaChecks.);                                                                                                                                                                          
*/                                                                                                                                                                                                                                                              
